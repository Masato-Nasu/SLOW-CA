<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Lemma-Driven CA 2D (4éšèª¿)</title>
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{
      --bg:#0d0d0d; --panel:#161616; --panel2:#1f1f1f; --text:#eaeaea; --muted:#a8a8a8;
      --accent:#7bdff2;
    }
    *{box-sizing:border-box; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;}
    body{margin:0; background:var(--bg); color:var(--text); display:flex; min-height:100vh;}
    #app{display:grid; grid-template-columns: 1fr 320px; width:100%;}
    canvas{width:100%; height:100%; display:block; background:#000;}
    aside{background:var(--panel); border-left:1px solid #2a2a2a; padding:12px; overflow:auto;}
    h1{font-size:18px; margin:6px 0 10px;}
    .row{display:flex; gap:8px; align-items:center; margin:8px 0;}
    .row label{flex:1; font-size:13px; color:var(--muted);}
    .row input[type="range"]{width:100%;}
    .btn{background:var(--panel2); border:1px solid #333; color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; font-size:13px;}
    .btn:hover{border-color:#555;}
    .btn.primary{background:#202a2a; border-color:#2e4a4a;}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:8px;}
    .small{font-size:12px; color:var(--muted); line-height:1.5;}
    .stat{font-size:12px; background:#111; padding:8px; border-radius:8px; border:1px solid #2a2a2a;}
    .legend{display:grid; grid-template-columns:auto 1fr; gap:6px 10px; font-size:12px; align-items:center;}
    .swatch{width:18px; height:18px; border-radius:4px; border:1px solid #555;}
    details{background:#121212; padding:8px; border-radius:8px; border:1px solid #2a2a2a; margin-top:10px;}
    summary{cursor:pointer; font-size:13px;}
    textarea{width:100%; height:84px; background:#0f0f0f; color:#eaeaea; border:1px solid #333; border-radius:8px; padding:8px; font-size:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    @media (max-width: 900px){
      #app{grid-template-columns:1fr; grid-template-rows: 1fr auto;}
      aside{border-left:none; border-top:1px solid #2a2a2a;}
    }
  </style>
</head>
<body>
<div id="app">
  <canvas id="cv"></canvas>
  <aside>
    <h1>Lemma-Driven CA 2Dï¼ˆ4éšèª¿ï¼‰</h1>
    <div class="small">
      å±€æ‰€ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ3Ã—3ï¼‰ã‹ã‚‰è¦³æ¸¬ã•ã‚ŒãŸã€Œå…¥â†’å‡ºã€ã‚’ãƒ¬ãƒ³ãƒè¾æ›¸ã¨ã—ã¦å­¦ç¿’ã—ã€
      ä»¥å¾ŒåŒã˜å±€æ‰€å›³å½¢ãŒå‡ºãŸã‚‰ãã®å‡ºåŠ›ã‚’é©ç”¨ã—ã¾ã™ã€‚æœªçŸ¥ã¯è–„ç°/æ¿ƒç°ã§æºã‚‰ãã¾ã™ã€‚
    </div>

    <div class="row">
      <label>ã‚µã‚¤ã‚º</label>
      <select id="sizeSel" class="btn">
        <option value="96">96</option>
        <option value="128" selected>128</option>
        <option value="160">160</option>
        <option value="192">192</option>
      </select>
    </div>

    <div class="row">
      <label>ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆè¡¨ç¤ºå€ç‡ï¼‰</label>
      <input id="scaleR" type="range" min="3" max="8" value="5" step="1">
      <div id="scaleV" style="width:32px; text-align:right; font-size:12px;">5</div>
    </div>

    <div class="row">
      <label>é€Ÿåº¦ï¼ˆsteps / secï¼‰</label>
      <input id="speedR" type="range" min="1" max="60" value="20" step="1">
      <div id="speedV" style="width:32px; text-align:right; font-size:12px;">20</div>
    </div>

    <div class="row">
      <label>æœªçŸ¥ã®æºã‚‰ãå¼·åº¦</label>
      <input id="jitterR" type="range" min="0" max="1" value="0.70" step="0.01">
      <div id="jitterV" style="width:48px; text-align:right; font-size:12px;">0.70</div>
    </div>

    <div class="row">
      <label>å¿˜å´ç‡ï¼ˆè¾æ›¸ã®æ¸›è¡°ï¼‰</label>
      <input id="forgetR" type="range" min="0" max="0.01" value="0.0005" step="0.0005">
      <div id="forgetV" style="width:64px; text-align:right; font-size:12px;">0.0005</div>
    </div>

    <div class="grid2">
      <button id="playBtn" class="btn primary">â–¶ å†ç”Ÿ</button>
      <button id="stepBtn" class="btn">â­ 1ã‚¹ãƒ†ãƒƒãƒ—</button>
      <button id="seedBtn" class="btn">ğŸ² åˆæœŸåŒ–</button>
      <button id="clearBtn" class="btn">ğŸ§½ ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="row">
      <label>æç”»ãƒ¢ãƒ¼ãƒ‰</label>
      <select id="paintSel" class="btn">
        <option value="3">é»’ï¼ˆç¢ºå®š/ç”Ÿï¼‰</option>
        <option value="2">æ¿ƒç°ï¼ˆç«¶åˆ/ç”Ÿã«ãªã‚Šã‹ã‘ï¼‰</option>
        <option value="1">è–„ç°ï¼ˆæœªç¢ºå®š/æºã‚‰ãï¼‰</option>
        <option value="0">ç™½ï¼ˆç©ºï¼‰</option>
        <option value="-1" selected>æ¶ˆã—ã‚´ãƒ ï¼ˆå³ã‚¯ãƒªãƒƒã‚¯ï¼‰</option>
      </select>
    </div>

    <div class="legend">
      <div class="swatch" style="background:#ffffff"></div><div>0: ç™½ï¼ˆç©º/æ­»ï¼‰</div>
      <div class="swatch" style="background:#bdbdbd"></div><div>1: è–„ç°ï¼ˆæœªç¢ºå®š/æºã‚‰ãï¼‰</div>
      <div class="swatch" style="background:#5a5a5a"></div><div>2: æ¿ƒç°ï¼ˆç«¶åˆ/åŠç¢ºå®šï¼‰</div>
      <div class="swatch" style="background:#000000"></div><div>3: é»’ï¼ˆç¢ºå®š/ç”Ÿï¼‰</div>
    </div>

    <div class="row stat" id="stats"></div>

    <details>
      <summary>ãƒ¬ãƒ³ãƒè¾æ›¸ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</summary>
      <div class="small" style="margin:6px 0 4px;">ç¾åœ¨ã®è¾æ›¸ï¼ˆJSONï¼‰</div>
      <textarea id="dictArea" spellcheck="false"></textarea>
      <div class="grid2" style="margin-top:6px;">
        <button id="exportBtn" class="btn">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button id="importBtn" class="btn">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      </div>
      <div class="small" style="margin-top:6px;">
        â€»è¾æ›¸ã¯å±€æ‰€3Ã—3ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã€Œå…¥â†’å‡ºã€å¹³å‡ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚  
        å®Ÿé¨“ã®é€”ä¸­ã§ä¿å­˜/å†é–‹ãŒã§ãã¾ã™ã€‚
      </div>
    </details>

    <details>
      <summary>ä½¿ã„æ–¹</summary>
      <div class="small">
        ãƒ»ç”»é¢ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã¨ã‚»ãƒ«ã‚’æã‘ã¾ã™ï¼ˆå·¦ï¼é¸æŠçŠ¶æ…‹ã€å³ï¼ç™½ã§æ¶ˆå»ï¼‰ã€‚<br>
        ãƒ»å†ç”Ÿã™ã‚‹ã¨è¾æ›¸ãŒè‚²ã¡ã€é»’ã„â€œç¢ºå®šâ€ãŒå¢—ãˆã‚‹å‚¾å‘ãŒå‡ºã¾ã™ã€‚<br>
        ãƒ»æœªçŸ¥é ˜åŸŸã¯è–„ç°/æ¿ƒç°ã§ã‚†ã‚‰ãã¾ã™ï¼ˆãƒ¬ãƒ³ãƒã®è«–ç†ã®ã€Œä¸¡é/ä¸¡æ˜¯ã€é ˜åŸŸï¼‰ã€‚<br>
        ãƒ»é€Ÿåº¦ã‚„æºã‚‰ãã‚’å¤‰ãˆã‚‹ã¨ç›¸è»¢ç§»ãŒè¦‹ã‚„ã™ã„ã§ã™ã€‚
      </div>
    </details>

    <details>
      <summary>æŠ€è¡“ãƒ¡ãƒ¢ï¼ˆã‚ãªãŸå‘ã‘ï¼‰</summary>
      <div class="small">
        ãƒ»3Ã—3å±€æ‰€å…¥åŠ›ã‚’ base-4 ã§ç¬¦å·åŒ–ï¼ˆ0..3ï¼‰â†’ keyã€‚<br>
        ãƒ»å„ key ã«å¯¾ã—ã€å‡ºåŠ›3Ã—3ã®å¹³å‡ãƒ™ã‚¯ãƒˆãƒ«ã¨ã‚«ã‚¦ãƒ³ãƒˆã‚’ä¿æŒã€‚<br>
        ãƒ»æœªçŸ¥ key ã¯è¿‘å‚ã®ç°è‰²å‚¾å‘+æºã‚‰ãã§è£œé–“ã€‚<br>
        ãƒ»ç«¶åˆã¯ã€Œé‡ã¿ï¼ˆcountï¼‰ã€ã§ãƒ©ãƒ³ãƒ€ãƒ å„ªå…ˆï¼ˆsoft winner-take-allï¼‰ã€‚
      </div>
    </details>
  </aside>
</div>

<script>
(() => {
  // ---- PWA install & SW ----
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('sw.js'));
  }

  // ---- Canvas / Grid ----
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d', { alpha: false });
  let N = 128, scale = 5;
  function resizeCanvas(){
    cv.width = N * scale;
    cv.height = N * scale;
    cv.style.imageRendering = 'pixelated';
    draw();
  }

  const COLORS = ["#ffffff", "#bdbdbd", "#5a5a5a", "#000000"];

  let grid = new Uint8Array(N*N);
  let next = new Uint8Array(N*N);

  // Lemma dictionary: key -> {count, meanOut[9]}
  const dict = new Map();

  // ---- Utilities ----
  const idx = (x,y) => (y*N + x);
  const clamp = (v,a,b)=> v<a?a:v>b?b:v;
  const wrap = (v)=> (v+N)%N;

  function encode3x3(x,y, arr){
    // base-4 encoding of 3x3 neighborhood
    let key = 0;
    let p = 1;
    for(let dy=-1; dy<=1; dy++){
      for(let dx=-1; dx<=1; dx++){
        const v = arr[idx(wrap(x+dx), wrap(y+dy))];
        key += v * p;
        p *= 4;
      }
    }
    return key >>> 0;
  }

  function get3x3(x,y, arr, out9){
    let i=0;
    for(let dy=-1; dy<=1; dy++){
      for(let dx=-1; dx<=1; dx++){
        out9[i++] = arr[idx(wrap(x+dx), wrap(y+dy))];
      }
    }
  }

  function set3x3(x,y, arr, in9){
    let i=0;
    for(let dy=-1; dy<=1; dy++){
      for(let dx=-1; dx<=1; dx++){
        arr[idx(wrap(x+dx), wrap(y+dy))] = in9[i++];
      }
    }
  }

  // ---- Random seed ----
  function seed(){
    for(let i=0;i<grid.length;i++){
      const r = Math.random();
      grid[i] = r<0.72?0 : r<0.86?1 : r<0.95?2 : 3;
    }
  }

  function clearGrid(){
    grid.fill(0);
  }

  // ---- Update step (Lemma-driven) ----
  let jitter = 0.70;
  let forget = 0.0005;

  function step(){
    // 1) Create next by lemma application (soft, overlapping)
    next.set(grid); // start from current as base

    const in9 = new Uint8Array(9);
    const out9 = new Float32Array(9);

    // Accumulator for competing writes
    const accVal = new Float32Array(N*N);
    const accW   = new Float32Array(N*N);

    for(let y=0;y<N;y++){
      for(let x=0;x<N;x++){
        const key = encode3x3(x,y,grid);
        const entry = dict.get(key);
        if(entry){
          // Use learned mean output
          const mean = entry.mean;
          let i=0;
          for(let dy=-1; dy<=1; dy++){
            for(let dx=-1; dx<=1; dx++){
              const xx=wrap(x+dx), yy=wrap(y+dy);
              const id=idx(xx,yy);
              const w = Math.sqrt(entry.count);
              accVal[id] += mean[i]*w;
              accW[id]   += w;
              i++;
            }
          }
        } else {
          // Unknown: weak pull toward nearby gray tendency + jitter
          // compute local average
          let s=0;
          for(let dy=-1; dy<=1; dy++){
            for(let dx=-1; dx<=1; dx++){
              s += grid[idx(wrap(x+dx), wrap(y+dy))];
            }
          }
          const avg = s/9; // 0..3
          let i=0;
          for(let dy=-1; dy<=1; dy++){
            for(let dx=-1; dx<=1; dx++){
              const xx=wrap(x+dx), yy=wrap(y+dy);
              const id=idx(xx,yy);
              const noise = (Math.random()-0.5)*2*jitter; // [-jitter, jitter]
              const v = clamp(avg + noise, 0, 3);
              const w = 0.35;
              accVal[id] += v*w;
              accW[id]   += w;
              i++;
            }
          }
        }
      }
    }

    // Resolve accumulator -> next
    for(let i=0;i<next.length;i++){
      if(accW[i]>0){
        const v = accVal[i]/accW[i];
        next[i] = clamp(Math.round(v),0,3);
      } else {
        next[i] = grid[i];
      }
    }

    // 2) Learn lemmas from (grid -> next)
    const inBlock = new Uint8Array(9);
    const outBlock = new Uint8Array(9);
    for(let y=0;y<N;y++){
      for(let x=0;x<N;x++){
        const key = encode3x3(x,y,grid);
        get3x3(x,y, next, outBlock);
        let entry = dict.get(key);
        if(!entry){
          entry = { count: 0, mean: new Float32Array(9) };
          dict.set(key, entry);
        }
        entry.count += 1;
        const c = entry.count;
        for(let i=0;i<9;i++){
          entry.mean[i] += (outBlock[i] - entry.mean[i]) / c;
        }
      }
    }

    // 3) Forgetting / decay
    if(forget>0){
      for(const [k,e] of dict){
        e.count *= (1 - forget);
        if(e.count < 0.5){
          dict.delete(k);
        }
      }
    }


    // --- gray drift breaker: ç°è‰²ãŒé•·ãæ®‹ã‚‹å›ºå®šç‚¹ã‚’å£Šã™ ---
    for (let i = 0; i < grid.length; i++) {
      const v = next[i];
      if (v === 1 || v === 2) {
        if (Math.random() < 0.015) {
          let s = 0;
          const x = i % N;
          const y = (i / N) | 0;
          for (let dy = -1; dy <= 1; dy++) {
            for (let dx = -1; dx <= 1; dx++) {
              s += grid[idx(wrap(x+dx), wrap(y+dy))];
            }
          }
          const avg = s / 9;
          next[i] = avg > 1.5 ? 3 : 0;
        }
      }
    }

    // swap
    const tmp = grid; grid = next; next = tmp;

    draw();
    updateStats();
  }

  // ---- Draw ----
  function draw(){
    const w=cv.width, h=cv.height;
    // draw pixelated blocks
    for(let y=0;y<N;y++){
      for(let x=0;x<N;x++){
        ctx.fillStyle = COLORS[grid[idx(x,y)]];
        ctx.fillRect(x*scale, y*scale, scale, scale);
      }
    }
  }

  // ---- Controls ----
  const sizeSel = document.getElementById('sizeSel');
  const scaleR = document.getElementById('scaleR');
  const speedR = document.getElementById('speedR');
  const jitterR = document.getElementById('jitterR');
  const forgetR = document.getElementById('forgetR');

  const scaleV = document.getElementById('scaleV');
  const speedV = document.getElementById('speedV');
  const jitterV = document.getElementById('jitterV');
  const forgetV = document.getElementById('forgetV');

  function applySize(){
    N = parseInt(sizeSel.value,10);
    grid = new Uint8Array(N*N);
    next = new Uint8Array(N*N);
    dict.clear();
    seed();
    resizeCanvas();
    updateStats();
  }

  sizeSel.onchange = applySize;

  scaleR.oninput = () => {
    scale = parseInt(scaleR.value,10);
    scaleV.textContent = scale;
    resizeCanvas();
  };
  speedR.oninput = () => speedV.textContent = speedR.value;
  jitterR.oninput = () => { jitter = parseFloat(jitterR.value); jitterV.textContent = jitter.toFixed(2); };
  forgetR.oninput = () => { forget = parseFloat(forgetR.value); forgetV.textContent = forget.toFixed(4); };

  const playBtn = document.getElementById('playBtn');
  const stepBtn = document.getElementById('stepBtn');
  const seedBtn = document.getElementById('seedBtn');
  const clearBtn = document.getElementById('clearBtn');

  let playing=false, timer=null;
  function start(){
    if(timer) clearInterval(timer);
    const sp = parseInt(speedR.value,10);
    timer = setInterval(step, 1000/sp);
    playing=true;
    playBtn.textContent="â¸ åœæ­¢";
  }
  function stop(){
    if(timer) clearInterval(timer);
    timer=null;
    playing=false;
    playBtn.textContent="â–¶ å†ç”Ÿ";
  }
  playBtn.onclick = () => playing?stop():start();
  stepBtn.onclick = () => { if(!playing) step(); };
  seedBtn.onclick = () => { dict.clear(); seed(); draw(); updateStats(); };
  clearBtn.onclick = () => { dict.clear(); clearGrid(); draw(); updateStats(); };

  // ---- Painting ----
  const paintSel = document.getElementById('paintSel');
  let painting=false, paintVal=3;

  function pointerToCell(ev){
    const rect=cv.getBoundingClientRect();
    const x=Math.floor((ev.clientX-rect.left) / (rect.width / cv.width) / scale);
    const y=Math.floor((ev.clientY-rect.top) / (rect.height / cv.height) / scale);
    return {x:clamp(x,0,N-1), y:clamp(y,0,N-1)};
  }

  function paintAt(ev, val){
    const {x,y}=pointerToCell(ev);
    grid[idx(x,y)] = clamp(val,0,3);
    draw();
  }

  cv.addEventListener('pointerdown', (ev)=>{
    ev.preventDefault();
    painting=true;
    paintVal = parseInt(paintSel.value,10);
    if(ev.button===2){ paintVal=0; }
    paintAt(ev, paintVal>=0?paintVal:0);
    cv.setPointerCapture(ev.pointerId);
  });
  cv.addEventListener('pointermove', (ev)=>{
    if(!painting) return;
    const v = paintVal>=0?paintVal:0;
    paintAt(ev, v);
  });
  cv.addEventListener('pointerup', (ev)=>{ painting=false; cv.releasePointerCapture(ev.pointerId); });
  cv.addEventListener('contextmenu', e=>e.preventDefault());

  // ---- Export/Import dict ----
  const dictArea = document.getElementById('dictArea');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');

  function dictToJSON(){
    const obj = {};
    for(const [k,e] of dict){
      obj[k] = { c: e.count, m: Array.from(e.mean) };
    }
    return JSON.stringify({N, obj}, null, 2);
  }
  function jsonToDict(str){
    const data = JSON.parse(str);
    if(data.N && data.N!==N){
      sizeSel.value = String(data.N);
      applySize();
    }
    dict.clear();
    for(const k in data.obj){
      const e = data.obj[k];
      dict.set(Number(k), { count: e.c, mean: Float32Array.from(e.m) });
    }
  }

  exportBtn.onclick = ()=>{ dictArea.value=dictToJSON(); dictArea.select(); };
  importBtn.onclick = ()=>{
    try{
      jsonToDict(dictArea.value);
      updateStats();
    }catch(err){
      alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: " + err.message);
    }
  };

  // ---- Stats ----
  const statsEl = document.getElementById('stats');
  function updateStats(){
    let c0=0,c1=0,c2=0,c3=0;
    for(const v of grid){
      if(v===0)c0++; else if(v===1)c1++; else if(v===2)c2++; else c3++;
    }
    statsEl.innerHTML = `
      ã‚»ãƒ«æ•°: ${N}Ã—${N} / è¾æ›¸: ${dict.size} lemma<br>
      ç™½:${c0} è–„ç°:${c1} æ¿ƒç°:${c2} é»’:${c3}
    `;
  }

  // ---- Boot ----
  seed();
  resizeCanvas();
  updateStats();

})();
</script>
</body>
</html>
