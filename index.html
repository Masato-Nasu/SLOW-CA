<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Lemma-like Slow CA</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="./manifest.json">
  <style>
    body {
      margin: 0;
      background: #111;
      color: #eee;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: row;
      height: 100vh;
      overflow: hidden;
    }
    #left {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #222 0, #000 60%);
    }
    #right {
      width: 260px;
      padding: 12px 12px 16px;
      box-sizing: border-box;
      background: #111;
      border-left: 1px solid #333;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 12px;
    }
    canvas {
      image-rendering: pixelated;
      border-radius: 6px;
      box-shadow: 0 0 12px rgba(0,0,0,0.8);
      background: #000;
    }
    h1 {
      font-size: 14px;
      margin: 0 0 4px;
    }
    .panel {
      background: #181818;
      border-radius: 8px;
      padding: 8px;
      border: 1px solid #333;
    }
    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-top: 4px;
    }
    label {
      font-size: 11px;
      color: #ddd;
    }
    input[type=range] {
      flex: 1;
    }
    .val {
      width: 40px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    button {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #555;
      background: #222;
      color: #eee;
      cursor: pointer;
    }
    button:hover {
      background: #333;
    }
    .btn-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    small {
      color: #aaa;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div id="left">
    <canvas id="cv"></canvas>
  </div>
  <div id="right">
    <div class="panel">
      <h1>Slow CA (4éšèª¿Ã—ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼‹æ…£æ€§)</h1>
      <small>åæŸã—ã«ããã€ã‚†ã£ãã‚Šã†ã­ã‚‹ã‚ˆã†ã«å‹•ãCAã§ã™ã€‚</small>
      <div class="btn-row">
        <button id="playBtn">â–¶ å†ç”Ÿ</button>
        <button id="seedBtn">ğŸ² åˆæœŸåŒ–</button>
        <button id="clearBtn">â–¡ ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <div class="panel">
      <label>ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆã‚»ãƒ«ã®å¤§ãã•ï¼‰</label>
      <div class="row">
        <input id="scaleR" type="range" min="3" max="10" value="5">
        <span id="scaleV" class="val">5</span>
      </div>

      <label>é€Ÿåº¦ï¼ˆstep/ç§’ï¼‰</label>
      <div class="row">
        <input id="speedR" type="range" min="1" max="30" value="8">
        <span id="speedV" class="val">8</span>
      </div>

      <label>æ…£æ€§ï¼ˆ0 = é€Ÿã„ / 1 = ã¨ã¦ã‚‚é…ã„ï¼‰</label>
      <div class="row">
        <input id="alphaR" type="range" min="0" max="100" value="25">
        <span id="alphaV" class="val">0.25</span>
      </div>

      <label>æ›´æ–°å‰²åˆï¼ˆ1 = å…¨ã‚»ãƒ« / å°ã•ã„ã»ã©ã‚†ã£ãã‚Šï¼‰</label>
      <div class="row">
        <input id="updR" type="range" min="5" max="100" value="30">
        <span id="updV" class="val">0.30</span>
      </div>

      <label>ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯ rï¼ˆã‚«ã‚ªã‚¹åº¦ï¼‰</label>
      <div class="row">
        <input id="rR" type="range" min="300" max="400" value="370">
        <span id="rV" class="val">3.70</span>
      </div>
    </div>

    <div class="panel">
      <small>
        ãƒ»4éšèª¿ï¼ˆ0=é»’, 3=ç™½ï¼‰<br>
        ãƒ»å„ã‚»ãƒ«ã¯è¿‘å‚ã®å¹³å‡ â†’ ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å†™åƒ â†’ æ…£æ€§ãƒ–ãƒ¬ãƒ³ãƒ‰ â†’ éƒ¨åˆ†æ›´æ–°ã€ã®é †ã§æ›´æ–°ã•ã‚Œã¾ã™ã€‚<br>
        ãƒ»åæŸã—ã«ããã€ãšã£ã¨ã‚†ã£ãã‚Šã†ã­ã‚Šç¶šã‘ã‚‹ã‚ˆã†ã«è¨­è¨ˆã—ã¦ã‚ã‚Šã¾ã™ã€‚
      </small>
    </div>
  </div>

  <script>
    const cv = document.getElementById('cv');
    const ctx = cv.getContext('2d');

    const scaleR = document.getElementById('scaleR');
    const scaleV = document.getElementById('scaleV');
    const speedR = document.getElementById('speedR');
    const speedV = document.getElementById('speedV');
    const alphaR = document.getElementById('alphaR');
    const alphaV = document.getElementById('alphaV');
    const updR = document.getElementById('updR');
    const updV = document.getElementById('updV');
    const rR = document.getElementById('rR');
    const rV = document.getElementById('rV');

    const playBtn = document.getElementById('playBtn');
    const seedBtn = document.getElementById('seedBtn');
    const clearBtn = document.getElementById('clearBtn');

    let N = 128;
    let scale = parseInt(scaleR.value, 10);
    let grid = new Uint8Array(N * N);
    let next = new Uint8Array(N * N);

    function resizeCanvas() {
      scale = parseInt(scaleR.value, 10);
      const size = Math.min(window.innerWidth - 260 - 32, window.innerHeight - 40);
      const cells = Math.floor(size / scale);
      N = Math.max(32, Math.min(256, cells));
      cv.width = N * scale;
      cv.height = N * scale;
      grid = new Uint8Array(N * N);
      next = new Uint8Array(N * N);
      seed();
      draw();
    }

    function idx(x, y) {
      return ((y + N) % N) * N + ((x + N) % N);
    }

    function seed() {
      for (let i = 0; i < grid.length; i++) {
        const r = Math.random();
        // 0 å¤šã‚ã€1ã€œ3 ã‚‚å°‘ã—å…¥ã‚Œã‚‹
        grid[i] = r < 0.55 ? 0 : r < 0.75 ? 1 : r < 0.9 ? 2 : 3;
      }
    }

    function clearGrid() {
      grid.fill(0);
    }

    function stepOnce() {
      const rParam = parseInt(rR.value, 10) / 100; // 3.00ã€œ4.00
      const alpha = parseInt(alphaR.value, 10) / 100;
      const updateProb = parseInt(updR.value, 10) / 100;

      // 1) è¿‘å‚å¹³å‡ -> ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã§æ–°å€¤å€™è£œ next ã‚’ä½œã‚‹
      for (let y = 0; y < N; y++) {
        for (let x = 0; x < N; x++) {
          let s = 0;
          for (let dy = -1; dy <= 1; dy++) {
            for (let dx = -1; dx <= 1; dx++) {
              s += grid[idx(x + dx, y + dy)];
            }
          }
          const m = s / 9;      // 0..3
          let u = m / 3;        // 0..1
          let up = rParam * u * (1 - u); // logistic map
          if (!Number.isFinite(up)) up = 0.5;
          if (up < 0) up = 0;
          else if (up > 1) up = 1;
          const v = Math.floor(up * 4); // 0..3
          next[idx(x, y)] = v;
        }
      }

      // 2) æ…£æ€§ãƒ–ãƒ¬ãƒ³ãƒ‰ + éƒ¨åˆ†æ›´æ–°ã§ã‚†ã£ãã‚Šã«ã™ã‚‹
      for (let i = 0; i < next.length; i++) {
        const oldV = grid[i];
        const newV = next[i];
        const mixed = (1 - alpha) * oldV + alpha * newV;
        let v = Math.round(mixed);
        if (Math.random() > updateProb) {
          v = oldV;
        }
        if (v < 0) v = 0;
        else if (v > 3) v = 3;
        next[i] = v;
      }

            // --- é»’ã®ãƒªã‚·ãƒ¼ãƒ‰ï¼šé»’ãŒå°‘ãªã™ãã‚‹ã¨ãã«å°‘ã—ã ã‘é»’ã‚’è£œçµ¦ã™ã‚‹ ---
            let blackCount = 0;
            for (let i = 0; i < next.length; i++) {
              if (next[i] === 0) blackCount++;
            }
            if (blackCount < next.length * 0.02) { // é»’ãŒ2%æœªæº€ãªã‚‰
              for (let i = 0; i < next.length; i++) {
                if (next[i] > 0 && Math.random() < 0.008) {
                  next[i] = 0; // é»’ã®ç¨®
                }
              }
            }

      // 3) swap
      const tmp = grid;
      grid = next;
      next = tmp;
    }

    function draw() {
      const img = ctx.createImageData(N, N);
      const data = img.data;
      for (let i = 0; i < grid.length; i++) {
        const v = grid[i];
        const g = v === 0 ? 0 : v === 1 ? 80 : v === 2 ? 170 : 255;
        const j = i * 4;
        data[j] = g;
        data[j + 1] = g;
        data[j + 2] = g;
        data[j + 3] = 255;
      }
      // æ‹¡å¤§æç”»
      const tmpCanvas = document.createElement('canvas');
      tmpCanvas.width = N;
      tmpCanvas.height = N;
      tmpCanvas.getContext('2d').putImageData(img, 0, 0);
      ctx.imageSmoothingEnabled = false;
      ctx.clearRect(0, 0, cv.width, cv.height);
      ctx.drawImage(tmpCanvas, 0, 0, cv.width, cv.height);
    }

    // UI bindings
    scaleR.addEventListener('input', () => {
      scaleV.textContent = scaleR.value;
      resizeCanvas();
    });
    speedR.addEventListener('input', () => {
      speedV.textContent = speedR.value;
    });
    alphaR.addEventListener('input', () => {
      const a = (parseInt(alphaR.value, 10) / 100).toFixed(2);
      alphaV.textContent = a;
    });
    updR.addEventListener('input', () => {
      const u = (parseInt(updR.value, 10) / 100).toFixed(2);
      updV.textContent = u;
    });
    rR.addEventListener('input', () => {
      const rv = (parseInt(rR.value, 10) / 100).toFixed(2);
      rV.textContent = rv;
    });

    seedBtn.addEventListener('click', () => {
      seed();
      draw();
    });
    clearBtn.addEventListener('click', () => {
      clearGrid();
      draw();
    });

    // play loop (requestAnimationFrame)
    let playing = false;
    let lastT = 0;
    let acc = 0;

    function loop(t) {
      if (!playing) return;
      if (!lastT) lastT = t;
      const dt = (t - lastT) / 1000;
      lastT = t;
      acc += dt;

      const stepsPerSec = parseInt(speedR.value, 10);
      const stepDt = 1 / stepsPerSec;

      while (acc >= stepDt) {
        stepOnce();
        acc -= stepDt;
      }
      draw();
      requestAnimationFrame(loop);
    }

    playBtn.addEventListener('click', () => {
      playing = !playing;
      playBtn.textContent = playing ? "â¸ åœæ­¢" : "â–¶ å†ç”Ÿ";
      if (playing) {
        lastT = 0;
        acc = 0;
        requestAnimationFrame(loop);
      }
    });

    window.addEventListener('resize', () => {
      resizeCanvas();
    });

    // åˆæœŸè¨­å®š
    resizeCanvas();
    speedV.textContent = speedR.value;
    alphaV.textContent = (parseInt(alphaR.value, 10) / 100).toFixed(2);
    updV.textContent = (parseInt(updR.value, 10) / 100).toFixed(2);
    rV.textContent = (parseInt(rR.value, 10) / 100).toFixed(2);
    draw();

    // PWAç”¨ Service Worker ç™»éŒ²
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }
  </script>
</body>
</html>
